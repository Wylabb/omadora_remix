#!/bin/bash

omadora_path="$HOME/.local/share/omadora"

updates_found=0
messages=()

# Omadora repo updates
if ! git -C "$omadora_path" ls-remote &>/dev/null; then
  echo "Error: Unable to reach remote repository."
  exit 1
fi
latest_tag=$(git -C "$omadora_path" ls-remote --tags origin | grep -v "{}" | awk '{print $2}' | sed 's#refs/tags/##' | sort -V | tail -n 1)
current_tag=$(git -C "$omadora_path" describe --tags $(git -C "$omadora_path" rev-list --tags --max-count=1))

if [[ "$current_tag" != "$latest_tag" ]]; then
  messages+=("Omadora update available ($latest_tag)")
  updates_found=1
else
  messages+=("Omadora is up to date ($current_tag)")
fi

# Fedora system updates via dnf5
if command -v dnf5 >/dev/null 2>&1; then
  # Refresh metadata quietly
  dnf5 -q makecache >/dev/null 2>&1 || true
  dnf5 -q check-upgrade >/dev/null 2>&1
  rc=$?
  if [[ $rc -eq 100 ]]; then
    messages+=("Fedora system updates available via dnf5")
    updates_found=1
  elif [[ $rc -ne 0 ]]; then
    messages+=("Warning: dnf5 check-upgrade failed")
  fi
fi

# Firmware updates via fwupdmgr
if command -v fwupdmgr >/dev/null 2>&1; then
  fwupdmgr refresh --force >/dev/null 2>&1 || true
  if fwupdmgr get-updates 2>/dev/null | grep -qiE 'update available|upgrade available'; then
    messages+=("Firmware updates available via fwupdmgr")
    updates_found=1
  fi
fi

# Flatpak updates
if command -v flatpak >/dev/null 2>&1; then
  flatpak update --appstream -y >/dev/null 2>&1 || true
  if flatpak remote-ls --updates --app --runtime --columns=application 2>/dev/null | grep -q .; then
    messages+=("Flatpak updates available")
    updates_found=1
  fi
fi

# Cargo built binaries (via cargo-update)
if command -v cargo >/dev/null 2>&1 && cargo install-update --version >/dev/null 2>&1; then
  if CARGO_TERM_COLOR=never cargo install-update --list 2>/dev/null | awk '/^Package[[:space:]]+Installed[[:space:]]+Latest[[:space:]]+Needs[[:space:]]+update$/ { in=1; next } in && NF { if ($NF ~ /^Yes/) exit 0 } END { exit 1 }'; then
    messages+=("Cargo-installed binaries updates available via cargo install-update")
    updates_found=1
  fi
fi

# Print messages
for m in "${messages[@]}"; do
  echo "$m"
done

if [[ $updates_found -eq 1 ]]; then
  exit 0
else
  exit 1
fi
